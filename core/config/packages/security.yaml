security:
    password_hashers:
        App\Entity\User:
            algorithm: auto

    role_hierarchy:
        ROLE_SERVICE: [ 'ROLE_ADMIN' ]

    providers:
        app_user_provider:
            entity: { class: App\Entity\User, property: email }
        service_user_provider:
            memory:
                users:
                    core_service:
                        roles: [ 'ROLE_SERVICE' ]
        chain_provider:
            chain:
                providers: [ 'app_user_provider', 'service_user_provider' ]

    firewalls:
        dev: { pattern: ^/(_(profiler|wdt)|css|images|js)/, security: false }

        api:
            pattern: ^/api
            stateless: true
            provider: chain_provider
            user_checker: App\Security\UserChecker
            entry_point: jwt
            login_throttling:
                limiter: app.login_rate_limiter
            access_token:
                token_handler: App\Security\ServiceToken\ServiceTokenHandler
            json_login:
                check_path: /api/auth/login
                username_path: email
                password_path: password
                success_handler: lexik_jwt_authentication.handler.authentication_success
                failure_handler: lexik_jwt_authentication.handler.authentication_failure
            jwt: ~
            refresh_jwt:
                check_path: /api/auth/refresh

    access_control:
        # Public API endpoints
        - { path: ^/api/auth/(login|refresh)$, roles: PUBLIC_ACCESS, methods: [ POST ] }
        - { path: ^/api/auth/(register|logout)$, roles: PUBLIC_ACCESS, methods: [ POST ] }
        - { path: ^/api/auth/password/(forgot|reset)$, roles: PUBLIC_ACCESS, methods: [ POST ] }
        - { path: ^/api/auth/invite/complete$, roles: PUBLIC_ACCESS, methods: [ POST ] }
        - { path: ^/api/auth/invite/preview$, roles: PUBLIC_ACCESS, methods: [ GET ] }
        - { path: ^/api/setup/admin$, roles: PUBLIC_ACCESS, methods: [ POST ] }
        - { path: ^/api/auth/verify-email$, roles: PUBLIC_ACCESS, methods: [ GET ] }
        - { path: ^/api/config$, roles: PUBLIC_ACCESS, methods: [ GET ] }
        - { path: ^/api/docs, roles: PUBLIC_ACCESS, methods: [ GET ] }

        # Admin-only API endpoints
        - { path: ^/api/auth/invite$, roles: ROLE_ADMIN, methods: [ POST ] }
        - { path: ^/api/users/\d+/roles$, roles: ROLE_ADMIN, methods: [ POST ] }

        # Everything else requires authentication
        - { path: ^/api, roles: IS_AUTHENTICATED_FULLY, allow_if: "is_granted('MUTATION_FROM_ALLOWED_SOURCE')" }
        - { path: ^/, roles: IS_AUTHENTICATED_FULLY }
