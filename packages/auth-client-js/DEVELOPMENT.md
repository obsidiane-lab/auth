# Development Guide

## Architecture Overview

```
@obsidiane/auth-client-js
├── Bridge (Meridiane-generated)      ← Auto-generated from OpenAPI
│   ├── src/lib/                      ← HTTP client, facades, interceptors
│   ├── src/models/                   ← TypeScript types
│   └── src/public-api.ts             ← Main exports
│
├── CSRF Layer (manual)               ← Stays the same always
│   ├── csrf/csrf.ts                  ← Token generation & persistence
│   ├── csrf/csrf.interceptor.ts      ← Angular interceptor
│   └── index.ts                      ← Re-exports everything
│
└── Config
    ├── package.json                  ← NPM metadata
    ├── tsconfig.json                 ← TypeScript config
    └── .gitignore                    ← Ignore generated /src/
```

## File Structure

### Generated Files (auto-ignored)

```
src/                           ← GENERATED by Meridiane, ignored in git
├── lib/
│   ├── bridge/
│   │   ├── rest/              ← HTTP adapters
│   │   └── sse/               ← Realtime (optional)
│   ├── facades/               ← Resource facades
│   ├── interceptors/          ← HTTP interceptors
│   ├── ports/                 ← Interfaces
│   ├── utils/                 ← Helpers
│   ├── provide-bridge.ts      ← Angular provider
│   ├── bridge.types.ts        ← Core types
│   └── tokens.ts              ← DI tokens
├── models/                    ← Generated from OpenAPI schemas
└── public-api.ts              ← Main exports
```

### Manual Files (version-controlled)

```
csrf/                          ← CSRF layer (stay version-controlled)
├── csrf.ts                    ← Token generation/persistence
└── csrf.interceptor.ts        ← Angular interceptor
index.ts                       ← Re-exports
package.json
tsconfig.json
README.md
DEVELOPMENT.md (this file)
.gitignore
```

## Regeneration Workflow

### When Backend API Changes

1. **Backend deploys** new endpoints to `/api/docs.json`

2. **Run generation**:
   ```bash
   make sdks
   ```

3. **What happens**:
   - Downloads OpenAPI spec from `http://localhost:9000/api/docs.json`
   - Runs Meridiane to generate the bridge
   - Copies `src/` into `packages/auth-client-js/src/`
   - CSRF layer remains untouched

4. **Commit**:
   ```bash
   git add packages/auth-client-js/
   git commit -m "chore: regenerate SDKs from OpenAPI spec"
   ```

5. **Publish** (if needed):
   ```bash
   cd packages/auth-client-js
   npm run build
   npm publish
   ```

## Adding New Features

### Scenario 1: New HTTP Endpoint

**The endpoint is added in the backend API** → automatically generated by Meridiane.

```bash
make sdk-npm
# Done! New endpoint is in src/ automatically
```

### Scenario 2: Custom CSRF Logic

**Need to modify CSRF behavior?** Edit the manual files:

1. Modify `csrf/csrf.ts` (token generation, persistence)
2. Modify `csrf/csrf.interceptor.ts` (when/how to add token)
3. Rebuild and test

```bash
npm run build
npm test
```

## Building for Publication

```bash
# Install dependencies (if needed for TypeScript compilation)
npm install

# Build TypeScript → JavaScript
npm run build

# Output in ./dist/
ls -la dist/

# Publish to npm
npm publish
```

## Using in Applications

### In Angular App

```typescript
// app.config.ts
import { provideBridge } from '@obsidiane/auth-client-js';
import { CsrfInterceptor } from '@obsidiane/auth-client-js/csrf';

export const appConfig: ApplicationConfig = {
  providers: [
    provideBridge({
      baseUrl: 'http://localhost:9000',
    }),
    {
      provide: HTTP_INTERCEPTORS,
      useClass: CsrfInterceptor,
      multi: true,
    },
  ],
};
```

### In a Service

```typescript
import { FacadeFactory } from '@obsidiane/auth-client-js';
import type { UserUserRead } from '@obsidiane/auth-client-js';

@Injectable({ providedIn: 'root' })
export class UsersService {
  private readonly factory = inject(FacadeFactory);
  private readonly facade = this.factory.create<UserUserRead>({
    url: '/api/users',
  });

  getAll() {
    return this.facade.getCollection$();
  }

  getOne(id: string) {
    return this.facade.get$(id);
  }
}
```

## Testing

The CSRF layer is testable in isolation:

```typescript
import { generateCsrfToken, getCsrfTokenFromCookie, persistCsrfCookie } from '@obsidiane/auth-client-js/csrf';

describe('CSRF', () => {
  it('generates a token', () => {
    const token = generateCsrfToken();
    expect(token).toHaveLength(32);
  });

  it('persists to cookie', () => {
    const token = generateCsrfToken();
    persistCsrfCookie(token);
    const retrieved = getCsrfTokenFromCookie();
    expect(retrieved).toBe(token);
  });
});
```

The bridge (Meridiane) is tested separately in its own project.

## Troubleshooting

### Build Fails

```bash
npm run build

# If tsc not found
npm install
npm run build
```

### "Cannot find module 'src/public-api'"

The `src/` folder doesn't exist. You need to generate it:

```bash
make sdk-npm
```

### CSRF Token Not Working

1. Check that `CsrfInterceptor` is registered in Angular config
2. Verify cookies are enabled in browser
3. Check browser console for cookie warnings
4. Inspect `csrf-token` cookie in DevTools

## CI/CD Integration

Example GitHub Actions workflow:

```yaml
name: Publish SDK

on:
  push:
    branches: [main]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Regenerate from OpenAPI (ensures freshness)
      - run: make sdk-npm

      # Build
      - run: npm ci
        working-directory: packages/auth-client-js
      - run: npm run build
        working-directory: packages/auth-client-js

      # Publish to npm
      - run: npm publish
        working-directory: packages/auth-client-js
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

## Synchronization with webfront/bridge

Both the SDK and the webfront bridge are generated from the same OpenAPI spec:

- **webfront/bridge**: Direct use in the Angular app
- **packages/auth-client-js**: Packaged for reuse in other projects

They should be **identical in functionality** but:
- Bridge: used directly via imports (`import { provideBridge }`)
- SDK: packaged as npm module (`npm install @obsidiane/auth-client-js`)

Both can coexist in your monorepo.

## Maintenance Checklist

- [ ] Run `make sdks` after API changes
- [ ] Update `packages/auth-client-js/README.md` if CSRF behavior changes
- [ ] Test CSRF interceptor in app
- [ ] Version bump before publishing (in `package.json`)
- [ ] Run `npm run build` before release
- [ ] Commit `package.json` + `package-lock.json` changes

## References

- [Meridiane Documentation](https://github.com/obsidiane-lab/meridiane)
- [CSRF Protection Patterns](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html)
- [Angular HTTP Client](https://angular.io/guide/http)
- [Angular Dependency Injection](https://angular.io/guide/dependency-injection)
