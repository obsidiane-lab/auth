name: Release

on:
  push:
    tags:
      - '*.*.*'

env:
  IMAGE_NAME: 'obsidiane/auth'
  NPM_REGISTRY: ${{ vars.NPM_REGISTRY != '' && vars.NPM_REGISTRY || 'https://registry.npmjs.org' }}
  PUBLISH_NPM: ${{ vars.PUBLISH_NPM != '' && vars.PUBLISH_NPM || '1' }}

jobs:
  release:
    name: Publish Docker, npm and Packagist
    runs-on: ubuntu-latest
    env:
      REPOSITORY: ${{ github.repository }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: ${{ env.NPM_REGISTRY }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image
        id: build_image
        run: |
          if [ -z "${IMAGE_NAME:-}" ]; then
            echo "IMAGE_NAME environment variable is not set" >&2
            exit 1
          fi

          APP_VERSION="${GITHUB_REF_NAME}"
          echo "version=$APP_VERSION" >> "$GITHUB_OUTPUT"

          docker build \
            --build-arg APP_VERSION="$APP_VERSION" \
            --target frankenphp_prod \
            -t "$IMAGE_NAME:$APP_VERSION" \
            .

      - name: Run container and generate OpenAPI spec
        env:
          APP_VERSION: ${{ steps.build_image.outputs.version }}
        run: |
          set -e
          docker run -d --rm -p 8080:80 --name obsidiane-auth "$IMAGE_NAME:$APP_VERSION"

          echo "Waiting for API to be ready..."
          for i in $(seq 1 20); do
            if curl -fsS "http://localhost:8080/api/docs.json" -o openapi.json; then
              echo "OpenAPI spec downloaded to openapi.json"
              break
            fi
            echo "  retry #$i..."
            sleep 3
          done

          if [ ! -f openapi.json ]; then
            echo "Failed to fetch OpenAPI spec from container" >&2
            docker logs obsidiane-auth || true
            docker stop obsidiane-auth || true
            exit 1
          fi

          docker stop obsidiane-auth

      - name: Publish Docker image
        env:
          APP_VERSION: ${{ steps.build_image.outputs.version }}
        run: |
          docker push "$IMAGE_NAME:$APP_VERSION"
          docker tag "$IMAGE_NAME:$APP_VERSION" "$IMAGE_NAME:latest"
          docker push "$IMAGE_NAME:latest"

      - name: Publish npm package
        env:
          APP_VERSION: ${{ steps.build_image.outputs.version }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_REGISTRY: ${{ env.NPM_REGISTRY }}
          PUBLISH_NPM: ${{ env.PUBLISH_NPM }}
        working-directory: packages/auth-client-js
        run: |
          publish_flag=$(printf '%s' "${PUBLISH_NPM:-1}" | tr '[:upper:]' '[:lower:]')
          if [ -n "$publish_flag" ] && [ "$publish_flag" != "1" ] && [ "$publish_flag" != "true" ] && [ "$publish_flag" != "yes" ]; then
            echo "Skipping npm publish because PUBLISH_NPM is set to '$PUBLISH_NPM'."
            exit 0
          fi

          if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
            echo "NPM_TOKEN secret is not set; skipping npm publish."
            exit 0
          fi

          npm install
          npm version "$APP_VERSION" --no-git-tag-version
          npm publish \
            --access public \
            --registry "${NPM_REGISTRY:-https://registry.npmjs.org}"

  publish_packagist:
    name: Publish to Packagist
    runs-on: ubuntu-latest
    needs: release
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Trigger Packagist update
        uses: mnavarrocarter/packagist-update@v1.0.0
        with:
          username: ${{ secrets.PACKAGIST_USERNAME }}
          api_token: ${{ secrets.PACKAGIST_TOKEN }}
          package_name: obsidiane/auth-bundle
