name: Release

on:
    push:
        tags:
            - '*.*.*'

permissions:
    contents: read
    packages: write

concurrency:
    group: release-${{ github.ref_type }}-${{ github.ref_name }}
    cancel-in-progress: false

env:
    IMAGE_NAME: 'obsidiane/auth'
    NPM_REGISTRY: ${{ vars.NPM_REGISTRY != '' && vars.NPM_REGISTRY || 'https://registry.npmjs.org' }}
    PUBLISH_NPM: ${{ vars.PUBLISH_NPM != '' && vars.PUBLISH_NPM || '1' }}
    APP_VERSION: ${{ github.ref_name }}

jobs:
    docker:
        name: Build & publish Docker image + OpenAPI
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build Docker image
              run: |
                  set -e

                  if [ -z "${IMAGE_NAME:-}" ]; then
                    echo "IMAGE_NAME environment variable is not set" >&2
                    exit 1
                  fi

                  echo "Building Docker image ${IMAGE_NAME}:${APP_VERSION}"

                  docker build \
                    --build-arg APP_VERSION="${APP_VERSION}" \
                    --target frankenphp_prod \
                    -t "${IMAGE_NAME}:${APP_VERSION}" \
                    -t "${IMAGE_NAME}:latest" \
                    .

            - name: Run container and generate OpenAPI spec
              run: |
                  set -e

                  docker run -d --rm -p 8080:80 --name obsidiane-auth "${IMAGE_NAME}:${APP_VERSION}"

                  echo "Waiting for API to be ready..."
                  for i in $(seq 1 20); do
                    if curl -fsS "http://localhost:8080/api/docs.json" -o openapi.json; then
                      echo "OpenAPI spec downloaded to openapi.json"
                      break
                    fi
                    echo "  retry #$i..."
                    sleep 3
                  done

                  if [ ! -f openapi.json ]; then
                    echo "Failed to fetch OpenAPI spec from container" >&2
                    docker logs obsidiane-auth || true
                    docker stop obsidiane-auth || true
                    exit 1
                  fi

                  docker stop obsidiane-auth

            - name: Upload OpenAPI spec artifact
              uses: actions/upload-artifact@v4
              with:
                  name: openapi-${{ env.APP_VERSION }}
                  path: openapi.json

            - name: Push Docker image
              run: |
                  set -e
                  docker push "${IMAGE_NAME}:${APP_VERSION}"
                  docker push "${IMAGE_NAME}:latest"

    npm:
        name: Publish JS SDK to npm
        runs-on: ubuntu-latest
        needs: docker

        defaults:
            run:
                working-directory: packages/auth-client-js

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  registry-url: ${{ env.NPM_REGISTRY }}
                  cache: 'npm'

            - name: Install dependencies
              run: |
                  # npm ci est recommand√© si tu as un package-lock.json
                  if [ -f package-lock.json ]; then
                    npm ci
                  else
                    npm install
                  fi

            - name: Set package version
              run: npm version "${APP_VERSION}" --no-git-tag-version

            - name: Publish npm package
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: |
                  publish_flag=$(printf '%s' "${PUBLISH_NPM:-1}" | tr '[:upper:]' '[:lower:]')

                  if [ -n "$publish_flag" ] && [ "$publish_flag" != "1" ] && [ "$publish_flag" != "true" ] && [ "$publish_flag" != "yes" ]; then
                    echo "Skipping npm publish because PUBLISH_NPM is set to '$PUBLISH_NPM'."
                    exit 0
                  fi

                  if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
                    echo "NPM_TOKEN secret is not set; skipping npm publish."
                    exit 0
                  fi

                  npm publish \
                    --access public \
                    --registry "${NPM_REGISTRY:-https://registry.npmjs.org}"

    packagist:
        name: Trigger Packagist update
        runs-on: ubuntu-latest
        needs: [docker, npm]

        steps:
            - name: Checkout sources
              uses: actions/checkout@v4

            - name: Set up PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.2'
                  coverage: none

            - name: Validate PHP SDK manifest
              working-directory: packages/auth-client-php
              run: composer validate --no-interaction --no-check-publish

            - name: Trigger Packagist update
              uses: mnavarrocarter/packagist-update@v1.0.0
              with:
                  username: ${{ secrets.PACKAGIST_USERNAME }}
                  api_token: ${{ secrets.PACKAGIST_TOKEN }}
                  package_name: obsidiane/auth-bundle
