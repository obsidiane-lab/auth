name: Release

on:
    push:
        tags:
            - '*.*.*'

permissions:
    contents: read
    packages: write

concurrency:
    group: release-${{ github.ref_type }}-${{ github.ref_name }}
    cancel-in-progress: false

env:
    IMAGE_NAME: 'obsidiane/auth'
    NPM_REGISTRY: ${{ vars.NPM_REGISTRY != '' && vars.NPM_REGISTRY || 'https://registry.npmjs.org' }}
    PUBLISH_NPM: ${{ vars.PUBLISH_NPM != '' && vars.PUBLISH_NPM || '1' }}
    APP_VERSION: ${{ github.ref_name }}

jobs:
    docker:
        name: Build & publish Docker image + OpenAPI
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build Docker image
              run: |
                  set -e

                  if [ -z "${IMAGE_NAME:-}" ]; then
                    echo "IMAGE_NAME environment variable is not set" >&2
                    exit 1
                  fi

                  echo "Building Docker image ${IMAGE_NAME}:${APP_VERSION}"

                  docker build \
                    --build-arg APP_VERSION="${APP_VERSION}" \
                    --target frankenphp_prod \
                    -t "${IMAGE_NAME}:${APP_VERSION}" \
                    -t "${IMAGE_NAME}:latest" \
                    .

            - name: Push Docker image
              run: |
                  set -e
                  docker push "${IMAGE_NAME}:${APP_VERSION}"
                  docker push "${IMAGE_NAME}:latest"

    npm:
        name: Publish JS SDK to npm
        runs-on: ubuntu-latest
        needs: docker

        defaults:
            run:
                working-directory: packages/auth-client-js

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  registry-url: ${{ env.NPM_REGISTRY }}
                  cache: 'npm'
                  cache-dependency-path: packages/auth-client-js/package-lock.json

            - name: Install dependencies
              run: |
                  if [ -f package-lock.json ]; then
                    npm ci
                  else
                    npm install
                  fi

            - name: Set package version
              run: npm version "${APP_VERSION}" --no-git-tag-version

            - name: Publish npm package
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
              run: |
                  publish_flag=$(printf '%s' "${PUBLISH_NPM:-1}" | tr '[:upper:]' '[:lower:]')

                  if [ -n "$publish_flag" ] && [ "$publish_flag" != "1" ] && [ "$publish_flag" != "true" ] && [ "$publish_flag" != "yes" ]; then
                    echo "Skipping npm publish because PUBLISH_NPM is set to '$PUBLISH_NPM'."
                    exit 0
                  fi

                  if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
                    echo "NPM_TOKEN secret is not set; skipping npm publish."
                    exit 0
                  fi

                  npm publish \
                    --access public \
                    --registry "${NPM_REGISTRY:-https://registry.npmjs.org}"

    split_php_sdk:
        name: Split PHP SDK repo (auth-php-sdk)
        runs-on: ubuntu-latest
        needs: docker
        env:
            GITHUB_TOKEN: ${{ secrets.REPO_PUSH_TOKEN }}

        steps:
            - name: Checkout monorepo
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Split PHP SDK for tag
              uses: danharrin/monorepo-split-github-action@v2.4.0
              with:
                  tag: ${{ github.ref_name }}
                  branch: 'master'
                  package_directory: 'packages/auth-client-php'
                  repository_organization: 'obsidiane-lab'
                  repository_name: 'auth-php-sdk'
                  user_name: 'obsidiane-bot'
                  user_email: 'ci-bot@obsidiane-lab.dev'

    packagist:
        name: Trigger Packagist update
        runs-on: ubuntu-latest
        needs: [docker, split_php_sdk]

        steps:
            - name: Checkout sources
              uses: actions/checkout@v4

            - name: Set up PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  coverage: none

            - name: Validate PHP SDK manifest
              working-directory: packages/auth-client-php
              run: composer validate --no-interaction --no-check-publish

            - name: Trigger Packagist update
              uses: mnavarrocarter/packagist-update@v1.0.0
              with:
                  username: ${{ secrets.PACKAGIST_USERNAME }}
                  api_token: ${{ secrets.PACKAGIST_TOKEN }}
                  package_name: obsidiane/auth-sdk
